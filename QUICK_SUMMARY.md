# ‚ö° –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê: –ü—Ä–æ–±–ª–µ–º—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ handlers_v2

## üö® –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**handlers_v2 –ø–æ—Ç–µ—Ä—è–ª 85% —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ handlers.py**

```
–û—Ä–∏–≥–∏–Ω–∞–ª: 3,495 —Å—Ç—Ä–æ–∫ ‚Üí handlers_v2: 376 —Å—Ç—Ä–æ–∫
SmartDocumentProcessor (1,496 —Å—Ç—Ä–æ–∫) ‚Üí analyze_proforma_via_agent (—É–ø—Ä–æ—â–µ–Ω)
```

## ‚ùå –ß–¢–û –ü–û–¢–ï–†–Ø–ù–û (—Ç–æ–ø-10 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)

1. **SmartDocumentProcessor** ‚Üí –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π analyze_proforma_via_agent
2. **determine_buyer_organization** ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —á—É–∂–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤!)
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–≤–µ—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** ‚Üí 5 –ø–∞—Ä—Å–µ—Ä–æ–≤ —É–¥–∞–ª–µ–Ω—ã, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **smart_supplier_check** ‚Üí —É–ø—Ä–æ—â–µ–Ω, –Ω–µ—Ç VAT –≤–∞–ª–∏–¥–∞—Ü–∏–∏
5. **–ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ BILL creation** ‚Üí 954 —Å—Ç—Ä–æ–∫–∏ ‚Üí ~50 —Å—Ç—Ä–æ–∫ (–ø–æ—Ç–µ—Ä—è line_items, branch, –Ω–∞–ª–æ–≥–æ–≤)
6. **Branch Manager –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
7. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö line_items** ‚Üí —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è
8. **ITEM creation —Å selling price** ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
9. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π** ‚Üí –∑–∞–≥–ª—É—à–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
10. **–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤** ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

## ‚úÖ –ß–¢–û –•–û–†–û–®–û

1. **–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π handlers.py –ù–ï —É–¥–∞–ª–µ–Ω** - –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **Feature flags –≤—ã–∫–ª—é—á–µ–Ω—ã** - –Ω–æ–≤—ã–π –∫–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –±–µ–∑ —Ä–∏—Å–∫–∞

## üéØ –ß–¢–û –î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª (–ë–ï–ó–û–ü–ê–°–ù–û)
```bash
# 1. –ù–ï –¢–†–û–ì–ê–¢–¨ handlers.py
# 2. handlers_v2 - —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–û–í–´–• —Ñ—É–Ω–∫—Ü–∏–π
# 3. –ù–ï –≤–∫–ª—é—á–∞—Ç—å feature flags
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å handlers_v2 (–¢–†–£–î–û–ï–ú–ö–û)
```bash
# 1. –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å SmartDocumentProcessor
# 2. –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å determine_buyer_organization
# 3. –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ 10 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
# 4. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã (90%+ coverage)
# 5. 2 –Ω–µ–¥–µ–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ staging
# 6. –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –≤–∫–ª—é—á–∞—Ç—å feature flags
```

## üìä –ì–û–¢–û–í–ù–û–°–¢–¨ handlers_v2: ~15%

| –§—É–Ω–∫—Ü–∏—è | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å |
|---------|------------|
| PDF –æ–±—Ä–∞–±–æ—Ç–∫–∞ | 30% |
| Buyer/Seller detection | 0% |
| –¶–≤–µ—Ç–æ—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | 0% |
| BILL creation | 10% |
| Supplier check | 20% |
| Branch manager | 0% |
| VAT validation | 0% |
| Expense creation | 80% ‚úÖ |

## üö¶ DECISION TREE

```
‚îå‚îÄ –ù—É–∂–µ–Ω –ª–∏ –Ω–æ–≤—ã–π –∫–æ–¥ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°?
‚îÇ
‚îú‚îÄ –ù–ï–¢ ‚Üí 
‚îÇ  ‚îî‚îÄ –ò—Å–ø–æ–ª—å–∑—É–π handlers.py (3,495 —Å—Ç—Ä–æ–∫ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞)
‚îÇ     ‚îî‚îÄ handlers_v2 —Ä–∞–∑–≤–∏–≤–∞–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ë–ï–ó —Å–ø–µ—à–∫–∏
‚îÇ
‚îî‚îÄ –î–ê ‚Üí
   ‚îî‚îÄ handlers_v2 –≥–æ—Ç–æ–≤ –Ω–∞ 15%
      ‚îî‚îÄ –ù—É–∂–Ω–æ 5-8 –Ω–µ–¥–µ–ª—å –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
         ‚îî‚îÄ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π handlers.py –∫–∞–∫ –µ—Å—Ç—å
```

## üìã –ß–ï–ö–õ–ò–°–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–´–• –î–ï–ô–°–¢–í–ò–ô

- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å [REFACTORING_ANALYSIS.md](REFACTORING_ANALYSIS.md) - –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å [RECOVERY_PLAN.md](RECOVERY_PLAN.md) - –ø–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] **–†–ï–®–ï–ù–ò–ï**: –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å handlers_v2?
  - [ ] –û–ø—Ü–∏—è A: –û—Å—Ç–∞–≤–∏—Ç—å handlers.py –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
  - [ ] –û–ø—Ü–∏—è B: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å handlers_v2 (5-8 –Ω–µ–¥–µ–ª—å —Ä–∞–±–æ—Ç—ã)
- [ ] –ï—Å–ª–∏ –û–ø—Ü–∏—è B ‚Üí –ù–∞—á–∞—Ç—å —Å –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SmartDocumentProcessor
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –ü–ï–†–ï–î –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê

1. **–ù–ï –≤–∫–ª—é—á–∞—Ç—å feature flags** –ø–æ–∫–∞ handlers_v2 –Ω–µ –≥–æ—Ç–æ–≤ –Ω–∞ 100%
2. **–ù–ï —É–¥–∞–ª—è—Ç—å handlers.py** - —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –∫–æ–¥
3. **–ù–ï —É–ø—Ä–æ—â–∞—Ç—å** –∫–æ–¥ –µ—Å–ª–∏ —Ç–µ—Ä—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
4. **–°–û–ó–î–ê–¢–¨ —Ç–µ—Å—Ç—ã** –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

## üìû –í–û–ü–†–û–°–´ –î–õ–Ø –ö–û–ú–ê–ù–î–´

1. **–ó–∞—á–µ–º –±—ã–ª —Å–¥–µ–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥?** (—Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞? –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞?)
2. **–ü–æ—á–µ–º—É –Ω–µ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏?** (–Ω–µ—Ö–≤–∞—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏? –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ?)
3. **–ï—Å—Ç—å –ª–∏ deadline** –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ handlers_v2?
4. **–ö–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ?** (—Ü–≤–µ—Ç—ã? –∞–≤—Ç–æ–º–æ–±–∏–ª–∏? —Ä–∞—Å—Ö–æ–¥—ã?)

---

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å handlers.py –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π, handlers_v2 —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ë–ï–ó —Å–ø–µ—à–∫–∏.

**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- üìÑ [REFACTORING_ANALYSIS.md](REFACTORING_ANALYSIS.md) - –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- üìã [RECOVERY_PLAN.md](RECOVERY_PLAN.md) - –ø–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
