# ‚úÖ –ß–¢–û –†–ï–ê–õ–¨–ù–û –ï–°–¢–¨ –í –ö–û–î–ï

## üéØ –í–ê–ñ–ù–û: –í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏ –†–ê–ë–û–¢–ê–Æ–¢ –≤ handlers.py!

–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —Ç–æ–º —á—Ç–æ –∏—Ö –Ω–µ—Ç, –∞ –≤ —Ç–æ–º —á—Ç–æ **handlers_v2 –∏—Ö –Ω–µ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª**.

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:

### 1. ‚úÖ SmartDocumentProcessor - –ï–°–¢–¨ –∏ –†–ê–ë–û–¢–ê–ï–¢

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:**
- –ò–º–ø–æ—Ä—Ç: `handlers.py:16` 
```python
from src.domain.services.smart_document_processor import SmartDocumentProcessor
```

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `handlers.py:434-435`
```python
processor = SmartDocumentProcessor()
result = await processor.process_document(temp_path)
```

- –§–∞–π–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞: `functions/smart_document_processor.py` (1,496 —Å—Ç—Ä–æ–∫)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ù–ï –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç analyze_proforma_via_agent)

---

### 2. ‚úÖ determine_buyer_organization - –ï–°–¢–¨ –∏ –†–ê–ë–û–¢–ê–ï–¢

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:81-138` (58 —Å—Ç—Ä–æ–∫)

```python
def determine_buyer_organization(analysis: dict) -> tuple[str, str]:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è"""
    buyer_vat = (analysis.get('buyer_vat') or '').strip()
    buyer_name = (analysis.get('buyer_name') or '').strip().lower()
    
    # –ù–∞—à–∏ VAT –Ω–æ–º–µ—Ä–∞
    OUR_VATS = {
        'PL5272956146': ('20082562863', 'PARKENTERTAINMENT'),
        'EE102288270': ('20092948714', 'TaVie Europe O√ú')
    }
    # ... –∏ –µ—â–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `handlers.py:513` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- `handlers.py:806` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è URL
- `handlers.py:859` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è ITEM
- `handlers.py:1057` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è ITEM creation
- `handlers.py:1580` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
- `handlers.py:1901` - —Å–æ–∑–¥–∞–Ω–∏–µ BILL
- `handlers.py:3283` - —Å–æ–∑–¥–∞–Ω–∏–µ Expense

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 7+ —Ä–∞–∑)  
**handlers_v2:** ‚ùå –ù–ï–¢ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

---

### 3. ‚úÖ –¶–≤–µ—Ç–æ—á–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã - –í–°–ï 5 –ï–°–¢–¨ –∏ –†–ê–ë–û–¢–ê–Æ–¢

**–ò–º–ø–æ—Ä—Ç—ã –≤ handlers.py:**
- –°—Ç—Ä–æ–∫–∞ 18: `extract_flower_lines_from_ocr, parse_invoice_items`
- –°—Ç—Ä–æ–∫–∞ 19: `extract_all_flower_positions, format_for_telegram_bot`
- –°—Ç—Ä–æ–∫–∞ 20: `extract_flower_positions_from_pdf`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handle_smart_create_bill (—Å—Ç—Ä–æ–∫–∏ 2030-2174):**

```python
# 1. pdfplumber_flower_parser (—Å—Ç—Ä–æ–∫–∞ 2085)
from functions.pdfplumber_flower_parser import extract_flower_positions_pdfplumber

# 2. perfect_flower_parser (—Å—Ç—Ä–æ–∫–∞ 2135)  
from functions.perfect_flower_parser import extract_perfect_flower_data

# 3. extract_flower_lines_from_ocr (—Å—Ç—Ä–æ–∫–∞ 2038)
parsed_ocr = extract_flower_lines_from_ocr(raw_text)

# 4. pdf_direct_parser (—Å—Ç—Ä–æ–∫–∞ 2064)
pdf_raw = extract_flower_positions_from_pdf(processed_path)

# 5. pdfminer_flower_parser (—Å—Ç—Ä–æ–∫–∞ 2109)
from functions.pdfminer_flower_parser import extract_flowers_with_pdfminer
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï 5 –†–ê–ë–û–¢–ê–Æ–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ù–ï–¢ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞

---

### 4. ‚úÖ BILL creation - –ü–û–õ–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –ï–°–¢–¨

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:1863-2817` (954 —Å—Ç—Ä–æ–∫–∏!)

```python
async def handle_smart_create_bill(update, context):
    """–°–æ–∑–¥–∞–Ω–∏–µ Bill –≤ Zoho (–≤–∫–ª—é—á–∞—è —Ü–≤–µ—Ç–æ—á–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã)"""
    
    # –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –µ—Å–ª–∏ –Ω–µ—Ç line_items
    if 'line_items' not in analysis:
        processor = SmartDocumentProcessor()
        result = await processor.process_document(processed_path)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö line_items –∏–∑ LLM (—Å—Ç—Ä–æ–∫–∏ 2373-2502)
    llm_line_items = analysis.get('line_items') or []
    for llm_item in llm_line_items:
        # –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ line_item
    
    # Branch Manager (—Å—Ç—Ä–æ–∫–∏ 2572-2639)
    from src.domain.services.branch_manager import BranchManager
    branch_id, branch_reason = branch_manager.get_branch_for_flower_document(...)
    
    # Inclusive/exclusive –Ω–∞–ª–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 1993-2035)
    if hibispol_brutto_pattern:
        inclusive = True
    
    # Account selection —á–µ—Ä–µ–∑ LLM (—Å—Ç—Ä–æ–∫–∏ 2505-2545)
    llm_pick = llm_select_account(...)
    
    # Attachment —Ñ–∞–π–ª–∞ (—Å—Ç—Ä–æ–∫–∏ 2766-2788)
    attach_response = requests.post(attach_url, files=files)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–Ø –ª–æ–≥–∏–∫–∞ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (~50 —Å—Ç—Ä–æ–∫)

---

### 5. ‚úÖ smart_supplier_check - –ü–û–õ–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ï–°–¢–¨

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:141-344` (203 —Å—Ç—Ä–æ–∫–∏!)

```python
async def smart_supplier_check(supplier_name, supplier_vat, our_company, analysis):
    """–£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:
    1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ –∫—ç—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏  
    3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤ –æ–±—â–µ–º –∫—ç—à–µ
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
    """
    
    from src.domain.services.contact_cache import OptimizedContactCache
    from src.domain.services.vat_validator import VATValidatorService
    
    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è VAT —Å country prefix (—Å—Ç—Ä–æ–∫–∏ 189-228)
    vvs_norm = VATValidatorService()
    validation_norm = vvs_norm.validate_vat(supplier_vat, expected_country=expected_country)
    
    # –ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ (—Å—Ç—Ä–æ–∫–∏ 232-320)
    org_cache = OptimizedContactCache(cache_file)
    found = org_cache.search_by_vat(search_vat)
    
    # VAT comparison (—Å—Ç—Ä–æ–∫–∏ 250-304)
    if cached_vat != doc_vat:
        return {'status': 'found_with_vat_mismatch', ...}
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** `handlers.py:766` - —É–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π find_supplier_in_zoho

---

### 6. ‚úÖ Branch Manager - –ï–°–¢–¨ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:2572-2639`

```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π BranchManager –¥–ª—è —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –≤–µ—Ç–æ–∫
from src.domain.services.branch_manager import BranchManager

branch_manager = BranchManager(access_token)

if is_flowers_doc:
    # –£–º–Ω—ã–π –≤—ã–±–æ—Ä –≤–µ—Ç–∫–∏ –¥–ª—è —Ü–≤–µ—Ç–æ—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    branch_id, branch_reason = branch_manager.get_branch_for_flower_document(
        org_id, supplier_name, doc_text_full
    )
else:
    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - Head Office
    head_office = branch_manager.get_head_office(org_id)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

---

### 7. ‚úÖ ITEM creation —Å selling price - –ü–û–õ–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –ï–°–¢–¨

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:999-1166` (167 —Å—Ç—Ä–æ–∫)

```python
async def handle_selling_price(update, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è ITEM"""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã (—Å—Ç—Ä–æ–∫–∏ 1006-1017)
    selling_price = float(price_text.replace(',', '.'))
    if selling_price <= 0:
        await update.message.reply_text("‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç –¥–ª—è PARKENTERTAINMENT (—Å—Ç—Ä–æ–∫–∏ 1110-1113)
    if org_id == "20082562863" and original_currency.upper() != "PLN":
        final_cost_price = convert_currency_to_pln(...)
        final_selling_price = convert_currency_to_pln(...)
    
    # Mileage extraction (—Å—Ç—Ä–æ–∫–∏ 1092-1101)
    mileage_match = re.search(r'(\d+)\s*(?:km|–∫–º)', description_en)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ ITEM (—Å—Ç—Ä–æ–∫–∏ 1115-1156)
    car_data = CarItemData(name, sku, description, cost_price, selling_price, ...)
    created = manager.create_car_item(car_data, org_id)
```

**–ì–¥–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:** `handlers.py:1826-1860` - handle_smart_create_item

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ù–ï–¢ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

---

### 8. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ - –ü–û–õ–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ï–°–¢–¨

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:2968-3137` (169 —Å—Ç—Ä–æ–∫)

```python
async def handle_photo(update, context):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PDF (—Å—Ç—Ä–æ–∫–∏ 2994-3002)
    image = Image.open(temp_photo_path)
    if image.mode != 'RGB':
        image = image.convert('RGB')
    image.save(pdf_file.name, 'PDF')
    
    # SmartDocumentProcessor (—Å—Ç—Ä–æ–∫–∏ 3011-3015)
    processor = SmartDocumentProcessor()
    result = await processor.process_document(temp_pdf_path)
    
    # –í—Å–µ —Ç–µ –∂–µ –∫–Ω–æ–ø–∫–∏ –∏ –ª–æ–≥–∏–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 3070-3113)
    if not (contact_comparison and exists_in_cache):
        buttons.append([InlineKeyboardButton("‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç")])
    
    buttons.append([InlineKeyboardButton("üí∞ Create Expense")])
    buttons.append([InlineKeyboardButton("üìã Create BILL")])
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** `handlers.py:2962` - `MessageHandler(filters.PHOTO, handle_photo)`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ó–∞–≥–ª—É—à–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### 9. ‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ - –ü–û–õ–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ï–°–¢–¨

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `handlers.py:3140-3231` (91 —Å—Ç—Ä–æ–∫–∞)

```python
async def handle_smart_analysis(update, context):
    """–ö–Ω–æ–ø–∫–∞: –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∫—Ä–∞—Ç–∫–∏–µ —Ç–µ–∑–∏—Å—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º)"""
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–µ contract_risks (—Å—Ç—Ä–æ–∫–∏ 3148-3172)
    risks = analysis.get('contract_risks') or {}
    if risks:
        # –í—ã–≤–æ–¥–∏–º payment_terms, delivery_terms, jurisdiction, warranty...
    
    # Fallback: LLM –∞–Ω–∞–ª–∏–∑ (—Å—Ç—Ä–æ–∫–∏ 3174-3201)
    else:
        llm = llm_analyze_contract_risks(text)
        # –ò–∑–≤–ª–µ–∫–∞–µ–º risks, unusual terms, penalties...
    
    # RU translation (—Å—Ç—Ä–æ–∫–∞ 3218)
    ru_summary = llm_translate_to_ru(raw_summary)
```

**–ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:** `handlers.py:1451` - callback "smart_analysis"

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –≤ handlers.py  
**handlers_v2:** ‚ùå –ù–ï–¢ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê

| # | –§—É–Ω–∫—Ü–∏—è | handlers.py | handlers_v2 | –§–∞–π–ª –≤ handlers.py |
|---|---------|-------------|-------------|--------------------|
| 1 | SmartDocumentProcessor | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 16, 434-435, 1870-1872, 3002-3015 |
| 2 | determine_buyer_organization | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 81-138 (58 —Å—Ç—Ä–æ–∫) |
| 3 | –¶–≤–µ—Ç–æ—á–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã (5 —à—Ç) | ‚úÖ –í–°–ï 5 | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 18-20, 2038-2174 |
| 4 | BILL creation (–ø–æ–ª–Ω–∞—è) | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 1863-2817 (954 —Å—Ç—Ä–æ–∫–∏) |
| 5 | smart_supplier_check | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 141-344 (203 —Å—Ç—Ä–æ–∫–∏) |
| 6 | Branch Manager | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 2572-2639 |
| 7 | ITEM creation (selling price) | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 999-1166 (167 —Å—Ç—Ä–æ–∫) |
| 8 | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 2968-3137 (169 —Å—Ç—Ä–æ–∫) |
| 9 | –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ | ‚úÖ –ï–°–¢–¨ | ‚ùå –ù–ï–¢ | –°—Ç—Ä–æ–∫–∏ 3140-3231 (91 —Å—Ç—Ä–æ–∫–∞) |

## üö® –í–´–í–û–î

### ‚úÖ handlers.py (–û–†–ò–ì–ò–ù–ê–õ):
**–í–°–ï 9 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –†–ê–ë–û–¢–ê–Æ–¢!**

–§–∞–π–ª: `/workspace/telegram_bot/handlers.py` (3,495 —Å—Ç—Ä–æ–∫)

### ‚ùå handlers_v2 (–ù–û–í–´–ô):
**–ù–ò –û–î–ù–û–ô –∏–∑ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ—Ç!**

–§–∞–π–ª—ã: 
- `/workspace/telegram_bot/handlers_v2/documents/document_handler.py` (251 —Å—Ç—Ä–æ–∫–∞)
- `/workspace/telegram_bot/handlers_v2/expenses/expense_handler.py` (125 —Å—Ç—Ä–æ–∫)

## üí° –ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢?

1. **handlers.py - –†–ê–ë–û–ß–ò–ô** ‚úÖ
   - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –º–µ—Å—Ç–µ
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
   - –ù–ï –¢–†–û–ì–ê–¢–¨!

2. **handlers_v2 - –ù–ï –ì–û–¢–û–í** ‚ùå
   - –ü–æ—Ç–µ—Ä—è–ª –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - –ù–µ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª –Ω–∏—á–µ–≥–æ –∏–∑ handlers.py
   - –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

3. **Feature flags –í–´–ö–õ–Æ–ß–ï–ù–´** ‚úÖ
   - handlers_v2 –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - –ü—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç handlers.py
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ

## üéØ –ß–¢–û –î–ï–õ–ê–¢–¨?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ù–ò–ß–ï–ì–û –ù–ï –ú–ï–ù–Ø–¢–¨ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# handlers.py - –ü–†–û–î–û–õ–ñ–ê–ï–¢ –†–ê–ë–û–¢–ê–¢–¨
# handlers_v2 - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–∫–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
# Feature flags - –ù–ï –í–ö–õ–Æ–ß–ê–¢–¨
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ handlers_v2

**–ù—É–∂–Ω–æ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –í–°–ï 9 —Ñ—É–Ω–∫—Ü–∏–π:**

1. SmartDocumentProcessor (1,496 —Å—Ç—Ä–æ–∫) ‚Üí –≤ handlers_v2/documents/
2. determine_buyer_organization (58 —Å—Ç—Ä–æ–∫) ‚Üí –≤ handlers_v2/utils/
3. –¶–≤–µ—Ç–æ—á–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã (5 —Ñ–∞–π–ª–æ–≤) ‚Üí –≤ handlers_v2/parsers/
4. BILL creation (954 —Å—Ç—Ä–æ–∫–∏) ‚Üí –≤ handlers_v2/bills/
5. smart_supplier_check (203 —Å—Ç—Ä–æ–∫–∏) ‚Üí –≤ handlers_v2/suppliers/
6. Branch Manager (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) ‚Üí –≤ handlers_v2/branch/
7. ITEM creation (167 —Å—Ç—Ä–æ–∫) ‚Üí –≤ handlers_v2/items/
8. Photo handling (169 —Å—Ç—Ä–æ–∫) ‚Üí –≤ handlers_v2/documents/
9. Contract analysis (91 —Å—Ç—Ä–æ–∫–∞) ‚Üí –≤ handlers_v2/analysis/

**–í—Ä–µ–º—è:** 6-8 –Ω–µ–¥–µ–ª—å —Ä–∞–±–æ—Ç—ã

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**–ù–ï –≤–∫–ª—é—á–∞–π—Ç–µ feature flags –ø–æ–∫–∞ handlers_v2 –Ω–µ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –í–°–ï —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏!**

```python
# ‚ùå –°–ï–ô–ß–ê–° (feature_flags.py):
FEATURES = {
    'use_new_document_handler': False,  # ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û, –ù–ï –í–ö–õ–Æ–ß–ê–¢–¨!
    'use_new_expense_handler': False,   # ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û, –ù–ï –í–ö–õ–Æ–ß–ê–¢–¨!
    ...
}
```

---

## üîç –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨ –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ handlers.py:
grep -n "^from\|^import" /workspace/telegram_bot/handlers.py | head -50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SmartDocumentProcessor:
grep -n "SmartDocumentProcessor" /workspace/telegram_bot/handlers.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–≤–µ—Ç–æ—á–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã:
grep -n "flower" /workspace/telegram_bot/handlers.py | head -20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å handle_smart_create_bill:
grep -n "def handle_smart_create_bill" /workspace/telegram_bot/handlers.py

# –†–∞–∑–º–µ—Ä handlers.py:
wc -l /workspace/telegram_bot/handlers.py

# –†–∞–∑–º–µ—Ä handlers_v2:
wc -l /workspace/telegram_bot/handlers_v2/documents/*.py
wc -l /workspace/telegram_bot/handlers_v2/expenses/*.py
```

---

**–ì–õ–ê–í–ù–û–ï**: handlers.py **–†–ê–ë–û–¢–ê–ï–¢**, handlers_v2 **–ù–ï –ì–û–¢–û–í**. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å handlers.py!
